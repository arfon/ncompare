# This workflow will install Python dependencies, run tests,
#   and report test results and code coverage as artifacts. It will
#   be called by the workflow that runs tests against new PRs and as
#   a first step in the workflow that publishes new Docker images.

name: A reusable workflow to build and run the unit test suite

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ '3.9', '3.10', '3.11' ]

    name: Python ${{ matrix.python-version }} tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up Poetry
        uses: abatilo/actions-poetry@v2.3.0
        with:
          poetry-version: 1.3.2

      - name: Install ncompare
        run: poetry install

      - name: Lint
        run: |
          poetry run ruff ncompare

      - name: Run tests with coverage
        run: |
          poetry run pytest --cov=ncompare --cov-report=xml:build/reports/coverage${{ matrix.python-version }}.xml --cov-report=html:build/reports/coverage${{ matrix.python-version }}.html --cov-report= tests/

      - uses: codecov/codecov-action@v3
        with:
          files: build/reports/coverage${{ matrix.python-version }}.xml
          verbose: true # optional (default = false)

#      - name: Archive code coverage report (xml)
#        if: ${{ always() }}
#        uses: actions/upload-artifact@v4
#        with:
#          name: code coverage report (xml)
#          path: build/reports/coverage${{ matrix.python-version }}.xml
#
#      - name: Archive code coverage report (HTML)
#        if: ${{ always() }}
#        uses: actions/upload-artifact@v4
#        with:
#          name: code coverage report (HTML)
#          path: build/reports/coverage${{ matrix.python-version }}.html
#
#
#  coverage:
#    name: Coverage
#    runs-on: ubuntu-latest
#    needs: build_and_test
#
#    steps:
#      - uses: actions/checkout@v4
#
#      - uses: tj-actions/coverage-badge-py@v2
#        id: coverage-badge-py
#        with:
#          # Output path (str) to write the coverage badge. Default: "coverage.svg".
#          output: '.images/coverage.svg'
#
#      - name: Verify Changed files
#        uses: tj-actions/verify-changed-files@v16
#        id: verify-changed-files
#        with:
#          files: .images/coverage.svg
#
#      - name: Commit files
#        if: steps.verify-changed-files.outputs.files_changed == 'true'
#        run: |
#          git config --local user.email "ncompare@noreply.github.com"
#          git config --local user.name "ncompare bot"
#          git add .images/coverage.svg
#          git commit -m "Updated coverage.svg"
#
#      - name: Push changes
#        if: steps.verify-changed-files.outputs.files_changed == 'true'
#        uses: ad-m/github-push-action@master
#        with:
#          github_token: ${{ secrets.github_token }}
#          branch: ${{ github.ref }}
